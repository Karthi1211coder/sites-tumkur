<!DOCTYPE html>
<html>
<head>
    <title>{% if is_edit %}Update Site{% else %}Upload Site{% endif %}</title>

    <!-- Leaflet CSS & JS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h2>
    {% if is_edit %}
        Update Site Details
    {% else %}
        Upload Site Details
    {% endif %}
</h2>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- ================= SITE CODE (READ ONLY) ================= -->
    {% if is_edit and form.initial.site_code %}
        <p>
            <label>Site Code:</label><br>
            <strong>{{ form.initial.site_code }}</strong>
        </p>
    {% endif %}

    <p><label>Site Name:</label><br>{{ form.name }}</p>
    <p><label>Location / City:</label><br>{{ form.location }}</p>
    <p><label>Area (sq.ft):</label><br>{{ form.area }}</p>
    <p><label>Price:</label><br>{{ form.price }}</p>
    <p><label>Owner:</label><br>{{ form.owner }}</p>
    <p><label>Plot Size (sq.ft):</label><br>{{ form.plot_size }}</p>
    <p><label>Facing:</label><br>{{ form.facing }}</p>
    <p><label>Ownership Type:</label><br>{{ form.ownership_type }}</p>
    <p><label>Availability:</label><br>{{ form.availability }}</p>
    <p><label>Road Width (ft):</label><br>{{ form.road_width }}</p>
    <p><label>Nearby Landmark:</label><br>{{ form.landmark }}</p>
    <p><label>Distance to Main Road (meters):</label><br>{{ form.distance_to_main_road }}</p>
    <p><label>Zoning Type:</label><br>{{ form.zoning_type }}</p>

    <!-- ================= LOCATION SEARCH ================= -->
    <h3>Find Location by Address</h3>

    <input type="text" id="addressInput"
           placeholder="Paste address or location name"
           style="width:300px;">

    <button type="button" onclick="searchLocation()">Find Location</button>

    <p style="font-size:12px; color:gray;">
        Example: "Tumakuru bus stand" or "MG Road Bengaluru"
    </p>

    <!-- ================= MAP LOCATION PICKER ================= -->
    <h3>Select Site Location on Map</h3>
    <p>You can click on the map to fine-tune the exact site location</p>

    <div
        id="map"
        data-lat="{{ form.initial.latitude|default:'' }}"
        data-lng="{{ form.initial.longitude|default:'' }}"
        style="height:400px; border:1px solid #000;">
    </div>

    <!-- Hidden fields to submit coordinates -->
    <input type="hidden" name="latitude" id="lat">
    <input type="hidden" name="longitude" id="lng">

    {% if is_edit and form.initial.image %}
        <p>
            <label>Current Image:</label><br>
            <img src="{{ form.initial.image }}" width="200">
        </p>
    {% endif %}

    <p>
        <label>Upload Image:</label><br>
        {{ form.image }}
        <small>
            {% if is_edit %}
                (Upload a new image only if you want to replace the existing one)
            {% else %}
                (Upload one image)
            {% endif %}
        </small>
    </p>

    <button type="submit">
        {% if is_edit %}Update Site{% else %}Upload Site{% endif %}
    </button>
</form>

<br>
<a href="{% url 'site_list' %}">View Approved Sites</a>

{% if is_edit %}
    <br><br>
    <a href="{% url 'admin_dashboard' %}">Back to Admin Dashboard</a>
{% endif %}

<!-- ================= PURE JAVASCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    var mapDiv = document.getElementById("map");
    var latAttr = mapDiv.dataset.lat;
    var lngAttr = mapDiv.dataset.lng;

    var map = L.map("map").setView([12.9716, 77.5946], 7); // Karnataka default

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    var marker = null;

    // Load existing marker (edit mode)
    if (latAttr && lngAttr) {
        var latNum = parseFloat(latAttr);
        var lngNum = parseFloat(lngAttr);

        if (!isNaN(latNum) && !isNaN(lngNum)) {
            marker = L.marker([latNum, lngNum]).addTo(map);
            map.setView([latNum, lngNum], 14);
            document.getElementById("lat").value = latNum;
            document.getElementById("lng").value = lngNum;
        }
    } else {
        // Optional helper: center near user
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (pos) {
                map.setView([pos.coords.latitude, pos.coords.longitude], 12);
            });
        }
    }

    // Click to place / move marker
    map.on("click", function (e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
    });

    // ---------- PLACE MARKER FUNCTION ----------
    function placeMarker(lat, lng) {
        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);

        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
    }

    // ---------- ADDRESS SEARCH (NOMINATIM) ----------
    window.searchLocation = function () {
        var address = document.getElementById("addressInput").value;

        if (!address) {
            alert("Please enter a location");
            return;
        }

        var url = "https://nominatim.openstreetmap.org/search?format=json&q="
                  + encodeURIComponent(address);

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (!data.length) {
                    alert("Location not found");
                    return;
                }

                var lat = parseFloat(data[0].lat);
                var lng = parseFloat(data[0].lon);

                placeMarker(lat, lng);
            })
            .catch(() => alert("Error fetching location"));
    };

});
</script>

</body>
</html>
